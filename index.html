<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>I Love Viernes Â· Golf Tracker</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
  <style>body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}</style>
</head>

<body class="min-h-screen bg-slate-100 text-slate-900 p-4 md:p-8">
  <!-- Opciones de puntos -->
  <datalist id="dlPuntos">
    <option value="No juega"></option>
    <option value="NJ"></option>
  </datalist>

  <!-- Campo: NO CAMBIO valores para no liarte -->
  <datalist id="dlCampo">
    <option value="RSH campo norte"></option>
    <option value="RSH campo sur"></option>
    <option value="RSH Norte"></option>
    <option value="RSH Sur"></option>
  </datalist>

  <div class="max-w-6xl mx-auto space-y-6">

    <!-- Header -->
    <header class="bg-white border border-slate-200 rounded-3xl shadow-sm p-6 md:p-8">
      <div class="text-center space-y-2">
        <h1 class="text-3xl md:text-5xl font-extrabold tracking-tight">ğŸŒï¸ Golf Tracker</h1>
        <div class="text-xl md:text-2xl font-black">ğŸ† I Love Viernes</div>
        <p class="text-slate-600 font-semibold">Temporada 2025â€“2026 Â· Pedro Â· Rodrigo Â· AgustÃ­n Â· Ricardo</p>

        <div class="mt-2 text-sm text-slate-600 leading-relaxed">
          <div>ğŸ <span class="font-extrabold text-slate-900">Bandera (Par 3)</span>: +1 para el <span class="font-extrabold text-slate-900">total</span> (cuenta aunque la partida sea âŒ). NO afecta al handicap.</div>
          <div>ğŸ† <span class="font-extrabold text-slate-900">Ganador</span>: +1 (si empate se reparte) para el <span class="font-extrabold text-slate-900">total</span> (cuenta aunque la partida sea âŒ). Ganador se decide por puntos base.</div>
          <div>ğŸ–ï¸ <span class="font-extrabold text-slate-900">Handicap</span>: se ajusta SOLO con puntos base (sin bonus ganador ni bandera).</div>
        </div>
      </div>

      <div class="mt-6 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
        <div class="rounded-2xl bg-slate-50 border border-slate-200 p-4">
          <div class="text-xs font-extrabold text-slate-500">PARTIDAS</div>
          <div id="kpiPartidas" class="text-3xl font-extrabold">0</div>
        </div>
        <div class="rounded-2xl bg-slate-50 border border-slate-200 p-4">
          <div class="text-xs font-extrabold text-slate-500">LÃDER (PUNTOS)</div>
          <div id="kpiLiderPuntos" class="text-xl font-extrabold mt-1">â€”</div>
        </div>
        <div class="rounded-2xl bg-slate-50 border border-slate-200 p-4">
          <div class="text-xs font-extrabold text-slate-500">LÃDER (VICTORIAS)</div>
          <div id="kpiLiderWins" class="text-xl font-extrabold mt-1">â€”</div>
        </div>
        <div class="rounded-2xl bg-slate-50 border border-slate-200 p-4">
          <div class="text-xs font-extrabold text-slate-500">LÃDER (BANDERAS)</div>
          <div id="kpiLiderBanderas" class="text-xl font-extrabold mt-1">â€”</div>
        </div>
      </div>
    </header>

    <!-- Formulario -->
    <section class="bg-white border border-slate-200 rounded-3xl shadow-sm p-6 md:p-8">
      <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
        <h2 id="formTitle" class="text-2xl font-extrabold">â• Nueva partida</h2>
        <button id="btnCancelEdit" class="hidden px-4 py-2 rounded-2xl font-extrabold bg-slate-200 hover:bg-slate-300" type="button">Cancelar ediciÃ³n</button>
      </div>

      <div class="mt-5 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
        <div>
          <label class="block text-sm font-bold text-slate-700 mb-1">ğŸ“… Fecha</label>
          <input id="fecha" type="date" class="w-full rounded-2xl border border-slate-200 bg-slate-50 p-3 font-semibold focus:outline-none focus:ring-4 focus:ring-slate-200">
        </div>
        <div>
          <label class="block text-sm font-bold text-slate-700 mb-1">â›³ Campo</label>
          <input id="campo" list="dlCampo" placeholder="RSH Norte/Sur o escribe otroâ€¦" class="w-full rounded-2xl border border-slate-200 bg-slate-50 p-3 font-semibold focus:outline-none focus:ring-4 focus:ring-slate-200">
        </div>

        <div>
          <label class="block text-sm font-bold text-slate-700 mb-1">Pedro (HCP <span id="hcpLbl_pedro">â€”</span>)</label>
          <input id="p_pedro" list="dlPuntos" placeholder="0-50 o NJ" class="w-full rounded-2xl border border-emerald-200 bg-emerald-50 p-3 font-extrabold focus:outline-none focus:ring-4 focus:ring-emerald-100">
        </div>
        <div>
          <label class="block text-sm font-bold text-slate-700 mb-1">Rodrigo (HCP <span id="hcpLbl_rodrigo">â€”</span>)</label>
          <input id="p_rodrigo" list="dlPuntos" placeholder="0-50 o NJ" class="w-full rounded-2xl border border-sky-200 bg-sky-50 p-3 font-extrabold focus:outline-none focus:ring-4 focus:ring-sky-100">
        </div>
        <div>
          <label class="block text-sm font-bold text-slate-700 mb-1">AgustÃ­n (HCP <span id="hcpLbl_agustin">â€”</span>)</label>
          <input id="p_agustin" list="dlPuntos" placeholder="0-50 o NJ" class="w-full rounded-2xl border border-violet-200 bg-violet-50 p-3 font-extrabold focus:outline-none focus:ring-4 focus:ring-violet-100">
        </div>
        <div>
          <label class="block text-sm font-bold text-slate-700 mb-1">Ricardo (HCP <span id="hcpLbl_ricardo">â€”</span>)</label>
          <input id="p_ricardo" list="dlPuntos" placeholder="0-50 o NJ" class="w-full rounded-2xl border border-amber-200 bg-amber-50 p-3 font-extrabold focus:outline-none focus:ring-4 focus:ring-amber-100">
        </div>

        <div class="md:col-span-2">
          <label class="block text-sm font-bold text-slate-700 mb-1">ğŸ Bandera (Par 3)</label>
          <select id="bandera" class="w-full rounded-2xl border border-slate-200 bg-slate-50 p-3 font-bold focus:outline-none focus:ring-4 focus:ring-slate-200">
            <option value="">â€” Nadie / No aplica â€”</option>
            <option value="pedro">Pedro</option>
            <option value="rodrigo">Rodrigo</option>
            <option value="agustin">AgustÃ­n</option>
            <option value="ricardo">Ricardo</option>
          </select>
          <p class="mt-1 text-xs text-slate-500 font-semibold">Suma +1 al total (cuenta incluso si la partida queda âŒ para Top-10). No afecta handicap ni ganador del dÃ­a.</p>
        </div>

        <div class="lg:col-span-2 flex items-end">
          <button id="btnSave" class="w-full rounded-3xl bg-slate-900 hover:bg-slate-800 text-white py-4 font-extrabold shadow-sm" type="button">ğŸ’¾ Guardar</button>
        </div>
      </div>
    </section>

    <!-- EstadÃ­sticas -->
    <section class="bg-white border border-slate-200 rounded-3xl shadow-sm p-6 md:p-8">
      <h2 class="text-2xl font-extrabold text-center">ğŸ“Š ClasificaciÃ³n</h2>

      <div class="mt-5 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
        <div class="rounded-2xl border border-emerald-200 bg-emerald-50 p-5">
          <div class="text-lg font-extrabold">Pedro</div>
          <div class="mt-3 text-sm font-bold text-slate-700 space-y-1">
            <div>ğŸ–ï¸ HCP: <span id="hcp_pedro" class="text-slate-900 font-extrabold">â€”</span></div>
            <div>ğŸ¯ Jugadas: <span id="played_pedro" class="text-slate-900 font-extrabold">0</span></div>
            <div>âœ… Top-10 usadas: <span id="top10_pedro" class="text-slate-900 font-extrabold">0/10</span></div>
            <div>ğŸ“Œ Total (General): <span id="total_pedro" class="text-slate-900 font-extrabold">0</span></div>
            <div>ğŸ¯ Base (Top-10): <span id="baseTop_pedro" class="text-slate-900 font-extrabold">0</span></div>
            <div>ğŸ† Bonus ganador (todas): <span id="bonus_pedro" class="text-slate-900 font-extrabold">0</span></div>
            <div>ğŸ Banderas (todas): <span id="banderas_pedro" class="text-slate-900 font-extrabold">0</span></div>
            <div>ğŸ† Victorias: <span id="wins_pedro" class="text-slate-900 font-extrabold">0</span></div>
            <div>â­ Mejor dÃ­a (base): <span id="best_pedro" class="text-slate-900 font-extrabold">0</span></div>
          </div>
        </div>

        <div class="rounded-2xl border border-sky-200 bg-sky-50 p-5">
          <div class="text-lg font-extrabold">Rodrigo</div>
          <div class="mt-3 text-sm font-bold text-slate-700 space-y-1">
            <div>ğŸ–ï¸ HCP: <span id="hcp_rodrigo" class="text-slate-900 font-extrabold">â€”</span></div>
            <div>ğŸ¯ Jugadas: <span id="played_rodrigo" class="text-slate-900 font-extrabold">0</span></div>
            <div>âœ… Top-10 usadas: <span id="top10_rodrigo" class="text-slate-900 font-extrabold">0/10</span></div>
            <div>ğŸ“Œ Total (General): <span id="total_rodrigo" class="text-slate-900 font-extrabold">0</span></div>
            <div>ğŸ¯ Base (Top-10): <span id="baseTop_rodrigo" class="text-slate-900 font-extrabold">0</span></div>
            <div>ğŸ† Bonus ganador (todas): <span id="bonus_rodrigo" class="text-slate-900 font-extrabold">0</span></div>
            <div>ğŸ Banderas (todas): <span id="banderas_rodrigo" class="text-slate-900 font-extrabold">0</span></div>
            <div>ğŸ† Victorias: <span id="wins_rodrigo" class="text-slate-900 font-extrabold">0</span></div>
            <div>â­ Mejor dÃ­a (base): <span id="best_rodrigo" class="text-slate-900 font-extrabold">0</span></div>
          </div>
        </div>

        <div class="rounded-2xl border border-violet-200 bg-violet-50 p-5">
          <div class="text-lg font-extrabold">AgustÃ­n</div>
          <div class="mt-3 text-sm font-bold text-slate-700 space-y-1">
            <div>ğŸ–ï¸ HCP: <span id="hcp_agustin" class="text-slate-900 font-extrabold">â€”</span></div>
            <div>ğŸ¯ Jugadas: <span id="played_agustin" class="text-slate-900 font-extrabold">0</span></div>
            <div>âœ… Top-10 usadas: <span id="top10_agustin" class="text-slate-900 font-extrabold">0/10</span></div>
            <div>ğŸ“Œ Total (General): <span id="total_agustin" class="text-slate-900 font-extrabold">0</span></div>
            <div>ğŸ¯ Base (Top-10): <span id="baseTop_agustin" class="text-slate-900 font-extrabold">0</span></div>
            <div>ğŸ† Bonus ganador (todas): <span id="bonus_agustin" class="text-slate-900 font-extrabold">0</span></div>
            <div>ğŸ Banderas (todas): <span id="banderas_agustin" class="text-slate-900 font-extrabold">0</span></div>
            <div>ğŸ† Victorias: <span id="wins_agustin" class="text-slate-900 font-extrabold">0</span></div>
            <div>â­ Mejor dÃ­a (base): <span id="best_agustin" class="text-slate-900 font-extrabold">0</span></div>
          </div>
        </div>

        <div class="rounded-2xl border border-amber-200 bg-amber-50 p-5">
          <div class="text-lg font-extrabold">Ricardo</div>
          <div class="mt-3 text-sm font-bold text-slate-700 space-y-1">
            <div>ğŸ–ï¸ HCP: <span id="hcp_ricardo" class="text-slate-900 font-extrabold">â€”</span></div>
            <div>ğŸ¯ Jugadas: <span id="played_ricardo" class="text-slate-900 font-extrabold">0</span></div>
            <div>âœ… Top-10 usadas: <span id="top10_ricardo" class="text-slate-900 font-extrabold">0/10</span></div>
            <div>ğŸ“Œ Total (General): <span id="total_ricardo" class="text-slate-900 font-extrabold">0</span></div>
            <div>ğŸ¯ Base (Top-10): <span id="baseTop_ricardo" class="text-slate-900 font-extrabold">0</span></div>
            <div>ğŸ† Bonus ganador (todas): <span id="bonus_ricardo" class="text-slate-900 font-extrabold">0</span></div>
            <div>ğŸ Banderas (todas): <span id="banderas_ricardo" class="text-slate-900 font-extrabold">0</span></div>
            <div>ğŸ† Victorias: <span id="wins_ricardo" class="text-slate-900 font-extrabold">0</span></div>
            <div>â­ Mejor dÃ­a (base): <span id="best_ricardo" class="text-slate-900 font-extrabold">0</span></div>
          </div>
        </div>
      </div>
    </section>

    <!-- Historial -->
    <section class="bg-white border border-slate-200 rounded-3xl shadow-sm p-6 md:p-8">
      <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
        <h2 class="text-2xl font-extrabold">ğŸ“‹ Historial</h2>
        <div class="flex gap-3">
          <button id="btnClear" class="px-4 py-2 rounded-2xl font-extrabold bg-red-600 hover:bg-red-700 text-white" type="button">ğŸ—‘ï¸ Borrar temporada</button>
          <button id="btnExport" class="px-4 py-2 rounded-2xl font-extrabold bg-slate-900 hover:bg-slate-800 text-white" type="button">ğŸ’¾ Exportar</button>
        </div>
      </div>

      <div class="mt-4 overflow-x-auto">
        <table class="w-full text-sm md:text-base">
          <thead>
            <tr class="bg-slate-900 text-white">
              <th class="p-3 text-left font-extrabold rounded-l-2xl">Fecha</th>
              <th class="p-3 text-left font-extrabold">Campo</th>
              <th class="p-3 text-center font-extrabold">Pedro</th>
              <th class="p-3 text-center font-extrabold">Rodrigo</th>
              <th class="p-3 text-center font-extrabold">AgustÃ­n</th>
              <th class="p-3 text-center font-extrabold">Ricardo</th>
              <th class="p-3 text-center font-extrabold">Ganador</th>
              <th class="p-3 text-center font-extrabold">ğŸ</th>
              <th class="p-3 text-center font-extrabold rounded-r-2xl">Acciones</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>

      <p class="mt-3 text-xs text-slate-500 font-semibold">âœ… = la BASE de esa partida entra en el Top-10 Â· âŒ = la BASE se descarta (pero ğŸ†/ğŸ suman igual) Â· ambas cuentan para hÃ¡ndicap</p>

      <div id="empty" class="hidden text-center py-10 text-slate-600 font-bold">ğŸ“ No hay partidas todavÃ­a.</div>
    </section>
  </div>

  <!-- Firebase Firestore (sin Auth): datos compartidos -->
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore-compat.js"></script>

  <script>
    // ğŸ”¥ Tu configuraciÃ³n Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyB5JSacRUi2OWIcOr9hyCplML56v9vWoKY",
      authDomain: "golf-tra.firebaseapp.com",
      projectId: "golf-tra",
      storageBucket: "golf-tra.firebasestorage.app",
      messagingSenderId: "1063285259916",
      appId: "1:1063285259916:web:77cfda107794913efd05a9"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // --- Config / Estado ---
    const HCP_DEFAULT = { pedro: 31, rodrigo: 12, agustin: 28, ricardo: 12 };
    const jugadores = [
      { key: "pedro", nombre: "Pedro", color: "text-emerald-700" },
      { key: "rodrigo", nombre: "Rodrigo", color: "text-sky-700" },
      { key: "agustin", nombre: "AgustÃ­n", color: "text-violet-700" },
      { key: "ricardo", nombre: "Ricardo", color: "text-amber-700" }
    ];

    let partidas = [];
    let hcpBase = { ...HCP_DEFAULT };
    let handicaps = { ...HCP_DEFAULT };
    let editingId = null;

    const $ = (id) => document.getElementById(id);

    function toast(msg, type="ok") {
      const d = document.createElement("div");
      d.className = "fixed top-4 right-4 z-50 px-5 py-3 rounded-2xl font-extrabold shadow-lg " +
        (type==="ok" ? "bg-emerald-600 text-white" : "bg-red-600 text-white");
      d.textContent = msg;
      document.body.appendChild(d);
      setTimeout(()=>d.remove(), 2600);
    }

    function fmt(x) {
      if (!Number.isFinite(x)) return "0";
      const r = Math.round(x*100)/100;
      return Number.isInteger(r) ? String(r) : r.toFixed(2).replace(".", ",");
    }

    function normText(s){ return (s ?? "").toString().trim(); }
    function normCampo(s){
      const t = normText(s).toLowerCase();
      if (t === "rsh norte" || t === "rsh campo norte") return "RSH campo norte";
      if (t === "rsh sur"   || t === "rsh campo sur")   return "RSH campo sur";
      return normText(s);
    }

    function parsePuntos(raw){
      const t = normText(raw).toLowerCase();
      if (!t) return { ok:false };
      if (t==="nj" || t==="no juega" || t==="n/j" || t==="nojuega") return { ok:true, played:false, value:null };
      const n = Number(t);
      if (!Number.isFinite(n) || !Number.isInteger(n) || n<0 || n>50) return { ok:false };
      return { ok:true, played:true, value:n };
    }

    function keyToNombre(k){ return (jugadores.find(j=>j.key===k)?.nombre) || ""; }

    // âœ… Puntos del dÃ­a (para mostrar en tabla y "mejor dÃ­a"): SOLO base
    function puntosDiaBase(p, key){
      const base = p.puntos?.[key];
      return Number.isFinite(base) ? base : null;
    }

    // âœ… ClasificaciÃ³n: base + bandera(+1 si aplica) + bonus ganador (+1 repartido)
    function puntosClasificacion(p, key){
      const base = p.puntos?.[key];
      if (!Number.isFinite(base)) return null;
      const extraBandera = (p.banderaKey===key) ? 1 : 0;
      return base + extraBandera;
    }

    // âœ… Ganador del dÃ­a se decide SOLO por puntos base (bandera NO cuenta)
    function computeGanadoresBase(p){
      const arr = jugadores
        .map(j => ({key:j.key, base:puntosDiaBase(p, j.key)}))
        .filter(x => Number.isFinite(x.base));
      if (arr.length<2) return { winnersKeys:[], ganadoresArr:[], ganadoresTxt:"â€”", bonusEach:0, maxBase:0 };
      const maxBase = Math.max(...arr.map(x=>x.base));
      const winnersKeys = arr.filter(x=>x.base===maxBase).map(x=>x.key);
      const winnersNames = winnersKeys.map(keyToNombre);
      const bonusEach = winnersKeys.length ? (1 / winnersKeys.length) : 0;
      return { winnersKeys, ganadoresArr:winnersNames, ganadoresTxt:winnersNames.join(" y "), bonusEach, maxBase };
    }

    // âœ… Handicap: SOLO por base (>=17 baja 1, <15 sube 1)
    function recalcularHandicapsDesdeBase(){
      const h = { ...hcpBase };
      const cron = [...partidas].slice().sort((a,b)=> (a.fecha||"").localeCompare(b.fecha||""));
      cron.forEach(p=>{
        jugadores.forEach(j=>{
          const base = p.puntos?.[j.key];
          if (!Number.isFinite(base)) return; // NJ => no cambia
          if (base >= 17) h[j.key] = Math.max(0, h[j.key]-1);
          else if (base < 15) h[j.key] = h[j.key]+1;
        });
      });
      handicaps = h;
    }

    function setEditMode(on){
      $("btnCancelEdit").classList.toggle("hidden", !on);
      $("formTitle").textContent = on ? "âœï¸ Editar partida" : "â• Nueva partida";
      $("btnSave").textContent = on ? "ğŸ’¾ Guardar cambios" : "ğŸ’¾ Guardar";
    }

    function clearForm(){
      $("fecha").valueAsDate = new Date();
      $("campo").value = "";
      $("p_pedro").value = "";
      $("p_rodrigo").value = "";
      $("p_agustin").value = "";
      $("p_ricardo").value = "";
      $("bandera").value = "";
    }

    function fillForm(p){
      $("fecha").value = p.fecha || "";
      $("campo").value = p.campo || "";
      $("p_pedro").value = Number.isFinite(p.puntos?.pedro) ? p.puntos.pedro : "NJ";
      $("p_rodrigo").value = Number.isFinite(p.puntos?.rodrigo) ? p.puntos.rodrigo : "NJ";
      $("p_agustin").value = Number.isFinite(p.puntos?.agustin) ? p.puntos.agustin : "NJ";
      $("p_ricardo").value = Number.isFinite(p.puntos?.ricardo) ? p.puntos.ricardo : "NJ";
      $("bandera").value = p.banderaKey || "";
    }

    async function loadBase(){
      const snap = await db.collection("meta").doc("state").get();
      const data = snap.exists ? snap.data() : null;
      const base = data?.hcpBase;
      if (base && jugadores.every(j=>Number.isFinite(base[j.key]))) {
        hcpBase = { ...base };
      } else {
        hcpBase = { ...HCP_DEFAULT };
        await db.collection("meta").doc("state").set({ hcpBase }, { merge:true });
      }
    }

    async function saveBase(newBase){
      hcpBase = { ...newBase };
      await db.collection("meta").doc("state").set({ hcpBase }, { merge:true });
    }

    function render(){
      $("kpiPartidas").textContent = String(partidas.length);

      // Stats globales (toda la temporada) + entradas para TOP-10 (solo clasificaciÃ³n)
      const all = {};
      const entries = {};
      jugadores.forEach(j=>{
        all[j.key] = { played:0, wins:0, bestBase:0, banderasTotal:0, bonusTotal:0 };
        entries[j.key] = [];
      });

      partidas.forEach(p=>{
        const g = computeGanadoresBase(p);

        jugadores.forEach(j=>{
          const base = puntosDiaBase(p, j.key);
          if (!Number.isFinite(base)) return; // NJ => no entra en conteos ni top-10

          all[j.key].played += 1;
          all[j.key].bestBase = Math.max(all[j.key].bestBase, base);

          const bandera = (p.banderaKey===j.key) ? 1 : 0;
          if (bandera) all[j.key].banderasTotal += 1;

          const isWinner = g.winnersKeys.includes(j.key);
          if (isWinner) all[j.key].wins += 1;

          const bonus = isWinner ? g.bonusEach : 0;
          all[j.key].bonusTotal += bonus;

          // Para clasificaciÃ³n: base + bandera(+1) + bonus ganador(+1 repartido)
          entries[j.key].push({
            id: p.id,
            fecha: p.fecha || "",
            base,
            bonus,
            bandera,
            clasif: base + bonus + bandera
          });
        });
      });

      // TOP-10 por jugador: se elige por BASE (sin bonus/bandera) y se corta a 10 aunque haya empate
      const top10Ids = {};
      const clasif = {};
      jugadores.forEach(j=>{
        const arr = entries[j.key] || [];
        const sorted = arr.slice().sort((a,b)=>{
          if (b.base !== a.base) return b.base - a.base;
          // Si hay empate en base, hacemos un desempate determinista para cortar en 10:
          // prioriza fecha mÃ¡s reciente y luego id.
          const da = a.fecha || "";
          const db = b.fecha || "";
          if (db !== da) return db.localeCompare(da);
          return (a.id || "").localeCompare(b.id || "");
        });

        const top = sorted.slice(0, 10);
        top10Ids[j.key] = new Set(top.map(x=>x.id));

        clasif[j.key] = {
          used: top.length,
          baseTop: top.reduce((sum,x)=> sum + (Number.isFinite(x.base) ? x.base : 0), 0),
          bonusTop: top.reduce((sum,x)=> sum + (Number.isFinite(x.bonus) ? x.bonus : 0), 0),
          banderasTop: top.reduce((sum,x)=> sum + (Number.isFinite(x.bandera) ? x.bandera : 0), 0)
        };

        // Total general = base (solo Top-10) + (bonus ganador + bandera) de TODAS las partidas jugadas
        clasif[j.key].total = (clasif[j.key].baseTop || 0) + (all[j.key].bonusTotal || 0) + (all[j.key].banderasTotal || 0);
      });

      // KPIs / clasificaciÃ³n
      const totals = jugadores.map(j=>({
        key: j.key,
        nombre: j.nombre,
        total: (clasif[j.key]?.total) || 0,
        wins: (all[j.key]?.wins) || 0,
        banderas: (all[j.key]?.banderasTotal) || 0
      }));

      const maxPts = Math.max(0, ...totals.map(x=>x.total));
      $("kpiLiderPuntos").textContent = maxPts>0 ? totals.filter(x=>x.total===maxPts).map(x=>x.nombre).join(" y ") : "â€”";

      const maxWins = Math.max(0, ...totals.map(x=>x.wins));
      $("kpiLiderWins").textContent = maxWins>0 ? totals.filter(x=>x.wins===maxWins).map(x=>x.nombre).join(" y ") : "â€”";

      const maxB = Math.max(0, ...totals.map(x=>x.banderas));
      $("kpiLiderBanderas").textContent = maxB>0 ? totals.filter(x=>x.banderas===maxB).map(x=>x.nombre).join(" y ") : "â€”";

      // pintar tarjetas (total/bonus/banderas SOLO de las TOP-10)
      jugadores.forEach(j=>{
        $("hcpLbl_"+j.key).textContent = handicaps[j.key];
        $("hcp_"+j.key).textContent = handicaps[j.key];

        $("played_"+j.key).textContent = all[j.key].played;

        const t = clasif[j.key] || { used:0, total:0, baseTop:0 };
        $("top10_"+j.key).textContent = `${t.used}/10`;
        $("total_"+j.key).textContent = fmt(t.total);
        $("baseTop_"+j.key).textContent = fmt(t.baseTop || 0);
        $("bonus_"+j.key).textContent = fmt(all[j.key].bonusTotal || 0);
        $("banderas_"+j.key).textContent = (all[j.key].banderasTotal || 0);

        // stats que NO se recortan a top-10 (informativos)
        $("wins_"+j.key).textContent = all[j.key].wins;
        $("best_"+j.key).textContent = all[j.key].bestBase;
      });

      // tabla
      const tbody = $("tbody");
      if (partidas.length===0) {
        tbody.innerHTML = "";
        $("empty").classList.remove("hidden");
        return;
      }
      $("empty").classList.add("hidden");

      tbody.innerHTML = partidas.map(p=>{
        const fechaTxt = (p.fecha ? new Date(p.fecha+"T00:00:00").toLocaleDateString("es-ES") : "â€”");
        const g = computeGanadoresBase(p);
        const band = p.banderaKey ? keyToNombre(p.banderaKey) : "â€”";

        const cell = (key, color) => {
          const base = p.puntos?.[key];
          if (!Number.isFinite(base)) return `<span class="font-extrabold ${color}">NJ</span>`;
          const b = (p.banderaKey===key) ? `<span class="ml-1 text-[10px] font-extrabold bg-slate-900 text-white px-2 py-0.5 rounded-full">ğŸ+1</span>` : "";
          const isTop = top10Ids?.[key]?.has(p.id);
          const topBadge = isTop
            ? `<span class="ml-1 text-[10px] font-extrabold bg-emerald-600 text-white px-2 py-0.5 rounded-full">âœ…</span>`
            : `<span class="ml-1 text-[10px] font-extrabold bg-slate-200 text-slate-700 px-2 py-0.5 rounded-full">âŒ</span>`;
          return `<span class="font-extrabold ${color}">${base}</span>${b}${topBadge}`;
        };

        const bonusBadge = g.ganadoresArr.length ? `<span class="ml-2 text-[10px] font-extrabold bg-emerald-600 text-white px-2 py-0.5 rounded-full">ğŸ†+${fmt(g.bonusEach)}</span>` : "";

        return `
          <tr class="border-b border-slate-200 hover:bg-slate-50">
            <td class="p-3 font-bold whitespace-nowrap">${fechaTxt}</td>
            <td class="p-3 font-semibold text-slate-700">${p.campo || ""}</td>
            <td class="p-3 text-center">${cell("pedro","text-emerald-700")}</td>
            <td class="p-3 text-center">${cell("rodrigo","text-sky-700")}</td>
            <td class="p-3 text-center">${cell("agustin","text-violet-700")}</td>
            <td class="p-3 text-center">${cell("ricardo","text-amber-700")}</td>
            <td class="p-3 text-center">
              <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-extrabold bg-slate-900 text-white">ğŸ¥‡ ${g.ganadoresTxt}</span>
              ${bonusBadge}
            </td>
            <td class="p-3 text-center font-extrabold text-slate-700">${band}</td>
            <td class="p-3 text-center whitespace-nowrap">
              <button class="px-3 py-2 rounded-xl font-extrabold bg-slate-200 hover:bg-slate-300" data-edit="${p.id}">âœï¸</button>
              <button class="ml-2 px-3 py-2 rounded-xl font-extrabold bg-red-600 hover:bg-red-700 text-white" data-del="${p.id}">ğŸ—‘ï¸</button>
            </td>
          </tr>
        `;
      }).join("");

      tbody.querySelectorAll("[data-edit]").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          const id = btn.getAttribute("data-edit");
          const p = partidas.find(x=>x.id===id);
          if (!p) return;
          editingId = id;
          setEditMode(true);
          fillForm(p);
          window.scrollTo({ top: 0, behavior: "smooth" });
        });
      });

      tbody.querySelectorAll("[data-del]").forEach(btn=>{
        btn.addEventListener("click", async ()=>{
          const id = btn.getAttribute("data-del");
          if (!confirm("Â¿Borrar esta partida?")) return;
          await db.collection("partidas").doc(id).delete();
          toast("ğŸ—‘ï¸ Partida borrada");
        });
      });
    }

    async function savePartida(){
      const fecha = $("fecha").value;
      const campo = normCampo($("campo").value);
      const banderaKey = $("bandera").value || "";

      if (!fecha || !campo) return toast("âš ï¸ Completa fecha y campo", "err");

      const raw = {
        pedro: $("p_pedro").value,
        rodrigo: $("p_rodrigo").value,
        agustin: $("p_agustin").value,
        ricardo: $("p_ricardo").value
      };

      const puntos = {};
      let playedCount = 0;
      for (const k of Object.keys(raw)){
        const r = parsePuntos(raw[k]);
        if (!r.ok) return toast('âš ï¸ Puntos: usa 0-50 o "NJ"/"No juega"', "err");
        puntos[k] = r.value;
        if (r.played) playedCount++;
      }
      if (playedCount < 2) return toast("âš ï¸ Deben jugar al menos 2 personas", "err");
      if (banderaKey && !Number.isFinite(puntos[banderaKey])) return toast("âš ï¸ Bandera no puede ser para alguien con NJ", "err");

      const data = {
        fecha,
        campo,
        puntos,
        banderaKey,
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      };

      if (editingId) {
        await db.collection("partidas").doc(editingId).set(data, { merge:true });
        toast("âœ… Cambios guardados");
      } else {
        data.createdAt = firebase.firestore.FieldValue.serverTimestamp();
        await db.collection("partidas").add(data);
        toast("âœ… Partida guardada");
      }

      editingId = null;
      setEditMode(false);
      clearForm();
    }

    async function clearSeason(){
      if (!confirm("âš ï¸ Â¿Borrar toda la temporada?")) return;

      // Base pasa a ser el handicap actual (Ãºltimo)
      await saveBase(handicaps);

      const snap = await db.collection("partidas").get();
      const docs = snap.docs;
      while (docs.length){
        const batch = db.batch();
        docs.splice(0, 450).forEach(d => batch.delete(d.ref));
        await batch.commit();
      }
      toast("ğŸ—‘ï¸ Temporada borrada");
    }

    function exportJSON(){
      const datos = {
        campeonato: "I Love Viernes",
        exportadoEn: new Date().toISOString(),
        hcpBase,
        handicapsActuales: handicaps,
        totalPartidas: partidas.length,
        reglas: {
          puntosDia: "Para mostrar 'dÃ­a' se usan puntos base. Bandera NO suma al dÃ­a.",
          clasificacion: "ClasificaciÃ³n total = base SOLO en las 10 mejores partidas de cada jugador (ordenadas por puntos base; NJ excluido; se corta en 10 aunque haya empate) + bonus ganador(+1 repartido) y banderas(+1) de TODAS las partidas jugadas (incluidas las descartadas).",
          ganador: "Ganador del dÃ­a = mayor puntos base (bandera no cuenta).",
          handicap: ">=17 baja 1, <15 sube 1 SOLO por puntos base. NJ no cambia."
        },
        partidas
      };
      const blob = new Blob([JSON.stringify(datos, null, 2)], { type:"application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `golf-ILoveViernes-${new Date().toISOString().slice(0,10)}.json`;
      a.click();
      URL.revokeObjectURL(url);
      toast("ğŸ’¾ Exportado");
    }

    async function boot(){
      $("fecha").valueAsDate = new Date();
      await loadBase();

      // Sync meta/hcpBase (si alguien borra temporada desde otro navegador)
      db.collection("meta").doc("state").onSnapshot((doc)=>{
        const d = doc.data();
        if (d?.hcpBase && jugadores.every(j=>Number.isFinite(d.hcpBase[j.key]))) {
          hcpBase = { ...d.hcpBase };
          recalcularHandicapsDesdeBase();
          render();
        }
      });

      // Sync partidas compartidas
      db.collection("partidas")
        .orderBy("fecha", "desc")
        .onSnapshot((snap)=>{
          partidas = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
          recalcularHandicapsDesdeBase();
          render();
        });

      $("btnSave").addEventListener("click", savePartida);
      $("btnCancelEdit").addEventListener("click", ()=>{
        editingId = null;
        setEditMode(false);
        clearForm();
        toast("EdiciÃ³n cancelada");
      });
      $("btnClear").addEventListener("click", clearSeason);
      $("btnExport").addEventListener("click", exportJSON);

      document.addEventListener("keydown", (e)=>{
        if (e.key === "Enter" && document.activeElement && String(document.activeElement.id||"").startsWith("p_")) {
          e.preventDefault();
          savePartida();
        }
      });
    }

    boot().catch(err=>{
      console.error(err);
      toast("âš ï¸ Error inicializando (mira Console)", "err");
    });
  </script>
</body>
</html>
